<div class="container store mt-5">
    <div class="row pt-4">
        <div class="col-12 d-flex justify-content-center text-center text-dark">
            <h1 class="fw-bold border-bottom w-25">STORE</h1>
        </div>
    </div>
    <div class="row">
        <div class="col-sm-12 col-md-6 col-lg-4 col-xl-3 mb-4 d-flex justify-content-center d-flex justify-content-center">
            <div class="card" style="width: 18rem;">
                <img src="./img/items/fruits.jpg" class="card-img-top" alt="fruits">
                <div class="card-body">
                    <h5 class="card-title">Fruits</h5>
                    <div class="row">
                        <div class="col-8 align-content-center">
                            <span class="fs-4">Rp. 10.000</span>
                        </div>
                        <div class="col-2">
                            <button type="button" class="btn btn-warning" data-id="1"><i class="fas fa-cart-plus"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-12 col-md-6 col-lg-4 col-xl-3 mb-4 d-flex justify-content-center">
            <div class="card" style="width: 18rem;">
                <img src="./img/items/kiwi.jpg" class="card-img-top" alt="kiwi">
                <div class="card-body">
                    <h5 class="card-title">Kiwi Fruits Yummy!</h5>
                    <div class="row">
                        <div class="col-8 align-content-center">
                            <span class="fs-4">Rp. 9.500</span>
                        </div>
                        <div class="col-2">
                            <button type="button" class="btn btn-warning" data-id="2"><i class="fas fa-cart-plus"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-12 col-md-6 col-lg-4 col-xl-3 mb-4 d-flex justify-content-center">
            <div class="card" style="width: 18rem;">
                <img src="./img/items/kiwi-bird.jpg" class="card-img-top" alt="kiwi-bird">
                <div class="card-body">
                    <h5 class="card-title">Kiwi Bird</h5>
                    <div class="row">
                        <div class="col-8 align-content-center">
                            <span class="fs-4">Rp. 950.000</span>
                        </div>
                        <div class="col-2">
                            <button type="button" class="btn btn-warning" data-id="3"><i class="fas fa-cart-plus"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-12 col-md-6 col-lg-4 col-xl-3 mb-4 d-flex justify-content-center">
            <div class="card" style="width: 18rem;">
                <img src="./img/items/kiwi-jam.jpg" class="card-img-top" alt="kiwi-jam">
                <div class="card-body">
                    <h5 class="card-title">Kiwi Jam</h5>
                    <div class="row">
                        <div class="col-8 align-content-center">
                            <span class="fs-4">Rp. 50.250</span>
                        </div>
                        <div class="col-2">
                            <button type="button" class="btn btn-warning" data-id="4"><i class="fas fa-cart-plus"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-12 col-md-6 col-lg-4 col-xl-3 mb-4 d-flex justify-content-center">
            <div class="card" style="width: 18rem;">
                <img src="./img/items/kiwi-oil.jpg" class="card-img-top" alt="kiwi-oil">
                <div class="card-body">
                    <h5 class="card-title">Kiwi Oil</h5>
                    <div class="row">
                        <div class="col-8 align-content-center">
                            <span class="fs-4">Rp. 46.000</span>
                        </div>
                        <div class="col-2">
                            <button type="button" class="btn btn-warning" data-id="5"><i class="fas fa-cart-plus"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-12 col-md-6 col-lg-4 col-xl-3 mb-4 d-flex justify-content-center">
            <div class="card" style="width: 18rem;">
                <img src="./img/items/kiwi-tree.jpg" class="card-img-top" alt="kiwi-tree">
                <div class="card-body">
                    <h5 class="card-title">Kiwi Tree</h5>
                    <div class="row">
                        <div class="col-8 align-content-center">
                            <span class="fs-4">Rp. 255.000</span>
                        </div>
                        <div class="col-2">
                            <button type="button" class="btn btn-warning" data-id="6"><i class="fas fa-cart-plus"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-12 col-md-6 col-lg-4 col-xl-3 mb-4 d-flex justify-content-center">
            <div class="card" style="width: 18rem;">
                <img src="./img/items/Kiwi_Seed.jpg" class="card-img-top" alt="kiwi-tree">
                <div class="card-body">
                    <h5 class="card-title">Kiwi Seed</h5>
                    <div class="row">
                        <div class="col-8 align-content-center">
                            <span class="fs-4">Rp. 100</span>
                        </div>
                        <div class="col-2">
                            <button type="button" class="btn btn-warning" data-id="7"><i class="fas fa-cart-plus"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-12 col-md-6 col-lg-4 col-xl-3 mb-4 d-flex justify-content-center">
            <div class="card" style="width: 18rem;">
                <img src="./img/items/melon.jpg" class="card-img-top" alt="kiwi-tree">
                <div class="card-body">
                    <h5 class="card-title">It isn't kiwi</h5>
                    <div class="row">
                        <div class="col-8 align-content-center">
                            <span class="fs-4">Rp. 35.000</span>
                        </div>
                        <div class="col-2">
                            <button type="button" class="btn btn-warning" data-id="8"><i class="fas fa-cart-plus"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript" src="https://app.sandbox.midtrans.com/snap/snap.js" data-client-key="client_key"></script>
<script>
let data = [];

function initialPembelian(datajson) {
    // ubah drop down dengan hapus data lama
    $('.row.barang').remove();
    // tambahkan data baru
    let itembaru = '';
    datajson.forEach(el => {
        let totalPrice = new Intl.NumberFormat('id', { style: 'currency', currency: 'IDR' }).format(el.total);
        itembaru += `<div class="row px-4 py-1 barang" id="barang-${el.id}">
                        <div class="col-3">${el.name}</div>
                        <div class="col-3 text-center totalharga">${totalPrice}</div>
                        <div class="col-4 text-center">
                            <span data-id="${el.id}" class="me-2 tambahbarang"><i class="fas fa-plus-circle"></i></span>
                            <span class="qty">${el.qty}</span>
                            <span data-id="${el.id}" class="ms-2 kurangbarang"><i class="fas fa-minus-circle"></i></span>
                        </div>
                        <div class="col-2 text-center">
                            <button type="button" class="badge bg-danger hapusbarang" data-id="${el.id}"><i class="fas fa-times"></i></button>
                        </div>
                    </div>`;
    });
    $('.dropdown-divider.top').after(itembaru);
    // ubah total pembelian
    let totalPembelian = 0;
    datajson.forEach(el => {
        totalPembelian += el.total;
    });
    totalPembelian = new Intl.NumberFormat('id', { style: 'currency', currency: 'IDR' }).format(totalPembelian);
    $('.row.total .totalpembelian').text(totalPembelian);
}
$(document).ready(function () {
    var buttonall = $('.store .row button');
    buttonall.on('click', function () {
        var id = $(this).data('id');
        var card = $(this).closest('.card');
        var name = card.find('.card-title').text();
        var priceText = card.find('.fs-4').text();
        var priceNumber = parseInt(priceText.replace(/[Rp. ]/g, ''), 10);
        var qty = 1;
        var total = priceNumber * qty;

        var jsondata = {
            id: id,
            name: name,
            price: priceNumber,
            qty: qty,
            total: total
        };
        // cek apakah data ada
        var dataExist = data.find(el => el.id === id) ? true : false;
        // jika ada maka tambahkan qty jika tidak maka tambahkan data
        if (dataExist) {
            data.forEach(el => {
                if (el.id === id) {
                    el.qty += 1;
                    el.total = el.price * el.qty;
                }
            });
        }else{
            data.push(jsondata);
        }

        // initialize pembelian
        initialPembelian(data);

        // initialisasi button pada chart
        // tambah barang
        $('.barang .tambahbarang').on('click', function (event) {
            event.stopPropagation();
            let idbarang = $(this).data('id');
            data.forEach(el => {
                if (el.id === idbarang) {
                    el.qty += 1;
                    el.total = el.price * el.qty;
                }
            });

            // ambil data barang
            let databarang = data.find(el => el.id === idbarang);
            // ubah harga dan qty barang
            let priceTotal = new Intl.NumberFormat('id', { style: 'currency', currency: 'IDR' }).format(databarang.total);
            let qty = databarang.qty;
            $('#barang-'+idbarang+' .totalharga').text(priceTotal);
            $('#barang-'+idbarang+' .qty').text(qty);
            // total pembelian
            let totalPembelian = 0;
            data.forEach(el => {
                totalPembelian += el.total;
            });
            totalPembelian = new Intl.NumberFormat('id', { style: 'currency', currency: 'IDR' }).format(totalPembelian);
            $('.row.total .totalpembelian').text(totalPembelian);
        });
        // kurang barang
        $('.barang .kurangbarang').on('click', function (event) {
            event.stopPropagation();
            let idbarang = $(this).data('id');
            
            data.forEach(el => {
                if (el.id === idbarang) {
                    el.qty -= 1;
                    if (el.qty < 1) {
                        el.qty = 1
                    }
                    el.total = el.price * el.qty;
                }
            });
            // ambil data barang
            let databarang = data.find(el => el.id === idbarang);
            // ubah harga dan qty barang
            let priceTotal = new Intl.NumberFormat('id', { style: 'currency', currency: 'IDR' }).format(databarang.total);
            let qty = databarang.qty;
            $('#barang-'+idbarang+' .totalharga').text(priceTotal);
            $('#barang-'+idbarang+' .qty').text(qty);
            // total pembelian
            let totalPembelian = 0;
            data.forEach(el => {
                totalPembelian += el.total;
            });
            totalPembelian = new Intl.NumberFormat('id', { style: 'currency', currency: 'IDR' }).format(totalPembelian);
            $('.row.total .totalpembelian').text(totalPembelian);
        });
        // hapus barang
        $('.barang .hapusbarang').on('click', function (event) {
            event.stopPropagation();
            let idbarang = $(this).data('id');
            data = data.filter(item => item.id !== idbarang);
            $('#barang-'+idbarang).remove();

            // total pembelian
            let totalPembelian = 0;
            data.forEach(el => {
                totalPembelian += el.total;
            });
            totalPembelian = new Intl.NumberFormat('id', { style: 'currency', currency: 'IDR' }).format(totalPembelian);
            $('.row.total .totalpembelian').text(totalPembelian);
            // update total
            let jumlahdata = data.length;
            let badge = `<span class="badge bg-danger position-absolute top-0 start-100 translate-middle jumlahbarang">${jumlahdata}</span>`;
            if (jumlahdata > 0) {
                $('.badge.jumlahbarang').remove();
                $('#btnChart').append(badge);
            }else{
                $('.badge.jumlahbarang').remove();
            }

            let barang = data.length;
            let nameVal = $('input[name="name"]').val();
            let emailVal = $('input[name="email"]').val();
            let phoneNumberVal = $('input[name="phoneNumber"]').val();
            
            if (nameVal !== '' && emailVal !== '' && phoneNumberVal !== '' && barang > 0) {
                $('#btnCheckout').removeClass('disabled');
                $('#btnCheckout').addClass('btn-outline-warning');
                $('#btnCheckout').prop('disabled', false);
            }else{
                $('#btnCheckout').removeClass('btn-outline-warning');
                $('#btnCheckout').addClass('disabled');
                $('#btnCheckout').prop('disabled', true);
            }
        });

        // ubah badge
        let jumlahdata = data.length;
        let badge = `<span class="badge bg-danger position-absolute top-0 start-100 translate-middle jumlahbarang">${jumlahdata}</span>`;
        if (jumlahdata > 0) {
            $('.badge.jumlahbarang').remove();
            $('#btnChart').append(badge);
        }else{
            $('.badge.jumlahbarang').remove();
        }
    });

    $('ul input').on('change input', function (event) {
        event.stopPropagation();
        let barang = data.length;
        let nameVal = $('input[name="name"]').val();
        let emailVal = $('input[name="email"]').val();
        let phoneNumberVal = $('input[name="phoneNumber"]').val();
        
        if (nameVal !== '' && emailVal !== '' && phoneNumberVal !== '' && barang > 0) {
            $('#btnCheckout').removeClass('disabled');
            $('#btnCheckout').addClass('btn-outline-warning');
            $('#btnCheckout').prop('disabled', false);
        }else{
            $('#btnCheckout').removeClass('btn-outline-warning');
            $('#btnCheckout').addClass('disabled');
            $('#btnCheckout').prop('disabled', true);
        }
    });

    $('#btnCheckout').on('click', function (event) {
        event.stopPropagation();
        let datajson = JSON.stringify(data);
        let nameVal = $('input[name="name"]').val();
        let emailVal = $('input[name="email"]').val();
        let phoneNumberVal = $('input[name="phoneNumber"]').val();
        let dataform = {
            name: nameVal,
            email: emailVal,
            phoneNumber: phoneNumberVal,
            data: datajson
        };
        // console.log(dataform);
        $.ajax({
            type: 'POST',
            url: '../apis/midrans_source.php',
            data: dataform,
            success: function (response) {
                snap.pay(response, {
                    onSuccess: function(result) {
                        console.log('Payment success:', result);
                        // Redirect to a success page
                        window.location.href = 'index.php?route=store';
                    },
                    onPending: function(result) {
                        console.log('Payment pending:', result);
                        // Redirect to a pending page if needed
                        window.location.href = 'index.php?route=store';
                    },
                    onError: function(result) {
                        console.log('Payment error:', result);
                        // Redirect to an error page
                        window.location.href = 'index.php?route=store';
                    },
                    onClose: function() {
                        console.log('Payment widget closed');
                    }
                });
            },
            error: function (error) {
                console.log(error);
            }
        });
    });
});
</script>